<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ë‚ ì§œì¡ì â€” ì•½ì† ë‚ ì§œ ì¡°ìœ¨</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body, #root { height: 100%; }
    body {
      font-family: 'Pretendard', 'Apple SD Gothic Neo', -apple-system, sans-serif;
      background: linear-gradient(145deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #e2e8f0;
      -webkit-font-smoothing: antialiased;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    input:focus { border-color: #38bdf8 !important; outline: none; }
    button { -webkit-appearance: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;
    const API_URL = "https://script.google.com/macros/s/AKfycbymt7l0HOJjSjdB4ElU67zkBVdHDLCadb-6ieG7uIT_PdlHOR1d0MMAf5S3AGrD0wx5/exec";

    // â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function parseDate(d) {
      if (!d) return null;
      if (typeof d === "string") {
        if (d.match(/^\d{4}-\d{2}-\d{2}$/)) { const [y,m,day] = d.split("-").map(Number); return new Date(y,m-1,day); }
        return new Date(d);
      }
      return new Date(d);
    }
    function fmtDate(date) {
      return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`;
    }
    function fmtDisplay(date) {
      const days = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      return `${date.getMonth()+1}/${date.getDate()}(${days[date.getDay()]})`;
    }
    function getDaysInMonth(y,m) { return new Date(y,m+1,0).getDate(); }
    function getFirstDayOfMonth(y,m) { return new Date(y,m,1).getDay(); }
    function isWeekend(y,m,d) { const day = new Date(y,m,d).getDay(); return day===0||day===6; }

    // 2026ë…„ í•œêµ­ ê³µíœ´ì¼ (ëŒ€ì²´ê³µíœ´ì¼ í¬í•¨)
    const KR_HOLIDAYS = {
      "2026-01-01": "ì‹ ì •",
      "2026-02-16": "ì„¤ë‚  ì—°íœ´",
      "2026-02-17": "ì„¤ë‚ ",
      "2026-02-18": "ì„¤ë‚  ì—°íœ´",
      "2026-03-01": "ì‚¼ì¼ì ˆ",
      "2026-03-02": "ì‚¼ì¼ì ˆ ëŒ€ì²´ê³µíœ´ì¼",
      "2026-05-05": "ì–´ë¦°ì´ë‚ ",
      "2026-05-24": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ",
      "2026-05-25": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚  ëŒ€ì²´ê³µíœ´ì¼",
      "2026-06-06": "í˜„ì¶©ì¼",
      "2026-08-15": "ê´‘ë³µì ˆ",
      "2026-08-17": "ê´‘ë³µì ˆ ëŒ€ì²´ê³µíœ´ì¼",
      "2026-09-24": "ì¶”ì„ ì—°íœ´",
      "2026-09-25": "ì¶”ì„",
      "2026-09-26": "ì¶”ì„ ì—°íœ´",
      "2026-10-03": "ê°œì²œì ˆ",
      "2026-10-05": "ê°œì²œì ˆ ëŒ€ì²´ê³µíœ´ì¼",
      "2026-10-09": "í•œê¸€ë‚ ",
      "2026-12-25": "í¬ë¦¬ìŠ¤ë§ˆìŠ¤",
    };

    function getHolidayName(dateStr) { return KR_HOLIDAYS[dateStr] || null; }
    function isHoliday(dateStr) { return !!KR_HOLIDAYS[dateStr]; }
    function isOff(y,m,d) {
      // ì£¼ë§ì´ê±°ë‚˜ ê³µíœ´ì¼ì´ë©´ ì‰¬ëŠ” ë‚ 
      const dateStr = fmtDate(new Date(y,m,d));
      return isWeekend(y,m,d) || isHoliday(dateStr);
    }

    async function apiCall(params) {
      const url = new URL(API_URL);
      Object.entries(params).forEach(([k,v]) => url.searchParams.append(k,v));
      const res = await fetch(url.toString());
      return res.json();
    }

    const VOTE_COLORS = {
      preferred: { bg: "#22c55e", text: "#fff", label: "ì„ í˜¸í•˜ëŠ” ë‚ ", emoji: "â™¥" },
      unavailable: { bg: "#ef4444", text: "#fff", label: "ì ˆëŒ€ ì•ˆë˜ëŠ” ë‚ ", emoji: "âœ•" },
    };
    const VOTE_CYCLE = [null, "preferred", "unavailable"];

    const inputStyle = {
      width: "100%", padding: "12px 14px", borderRadius: 10,
      border: "1px solid #334155", background: "#0f172a",
      color: "#e2e8f0", fontSize: 15, fontFamily: "inherit", outline: "none", boxSizing: "border-box",
    };

    // â”€â”€ ê³µí†µ ì»´í¬ë„ŒíŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function Card({ children, style }) {
      return <div style={{
        background: "rgba(30,41,59,0.8)", border: "1px solid #334155",
        borderRadius: 16, padding: 24, marginBottom: 16,
        backdropFilter: "blur(8px)", animation: "fadeIn 0.3s ease", ...style,
      }}>{children}</div>;
    }

    function Button({ children, onClick, disabled, variant="primary", style }) {
      const styles = {
        primary: { background: "linear-gradient(135deg,#0ea5e9,#38bdf8)", color: "#fff" },
        secondary: { background: "rgba(51,65,85,0.8)", color: "#cbd5e1", border: "1px solid #475569" },
        danger: { background: "linear-gradient(135deg,#dc2626,#ef4444)", color: "#fff" },
      };
      return <button onClick={onClick} disabled={disabled} style={{
        width: "100%", padding: "14px 20px", borderRadius: 12, border: "none",
        fontSize: 15, fontWeight: 700, cursor: disabled ? "default" : "pointer",
        opacity: disabled ? 0.5 : 1, transition: "all 0.2s", fontFamily: "inherit",
        ...styles[variant], ...style,
      }}>{children}</button>;
    }

    function LoadingSpinner() {
      return <div style={{ textAlign: "center", padding: 60 }}>
        <div style={{ width: 36, height: 36, border: "3px solid #334155", borderTop: "3px solid #38bdf8", borderRadius: "50%", animation: "spin 0.8s linear infinite", margin: "0 auto" }} />
      </div>;
    }

    function ErrorScreen({ message }) {
      return <Card><div style={{ textAlign: "center", padding: 24 }}>
        <div style={{ fontSize: 40, marginBottom: 12 }}>âš ï¸</div>
        <div style={{ fontSize: 16, color: "#f87171" }}>{message}</div>
      </div></Card>;
    }

    // â”€â”€ ê·¸ë£¹ ìƒì„± í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function CreateScreen({ form, setForm, onSubmit, loading }) {
      // í•µì‹¬êµ¬ê°„ ì„ íƒìš© ë¯¸ë‹ˆ ìº˜ë¦°ë” ìƒíƒœ
      const [selectingFocus, setSelectingFocus] = useState(false);
      const [focusStep, setFocusStep] = useState(0); // 0: ì‹œì‘ì¼ ì„ íƒ, 1: ì¢…ë£Œì¼ ì„ íƒ

      const today = new Date(); today.setHours(0,0,0,0);
      const maxDate = new Date(today); maxDate.setDate(maxDate.getDate() + 90);

      const handleFocusDateClick = (dateStr) => {
        if (focusStep === 0) {
          setForm({ ...form, focusStart: dateStr, focusEnd: "" });
          setFocusStep(1);
        } else {
          if (dateStr < form.focusStart) {
            setForm({ ...form, focusStart: dateStr, focusEnd: form.focusStart });
          } else {
            setForm({ ...form, focusEnd: dateStr });
          }
          setFocusStep(0);
          setSelectingFocus(false);
        }
      };

      const focusLabel = () => {
        if (form.focusStart && form.focusEnd) {
          const s = parseDate(form.focusStart);
          const e = parseDate(form.focusEnd);
          return `${fmtDisplay(s)} ~ ${fmtDisplay(e)}`;
        }
        if (form.focusStart) return `${fmtDisplay(parseDate(form.focusStart))} ~ (ì¢…ë£Œì¼ ì„ íƒ)`;
        return "";
      };

      // ë¯¸ë‹ˆ ìº˜ë¦°ë” ì›” ëª©ë¡
      const months = [];
      const cur = new Date(today.getFullYear(), today.getMonth(), 1);
      while (cur <= maxDate) {
        months.push({ year: cur.getFullYear(), month: cur.getMonth() });
        cur.setMonth(cur.getMonth() + 1);
      }

      return (
        <Card>
          <div style={{ fontSize: 18, fontWeight: 700, marginBottom: 20 }}>ìƒˆ ì•½ì† ë§Œë“¤ê¸°</div>
          <div style={{ marginBottom: 16 }}>
            <label style={{ fontSize: 13, color: "#94a3b8", display: "block", marginBottom: 6 }}>ë‚´ ì´ë¦„ (ë°œí–‰ì)</label>
            <input type="text" value={form.creator} onChange={e => setForm({...form, creator: e.target.value})} placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style={inputStyle} />
          </div>
          <div style={{ marginBottom: 16 }}>
            <label style={{ fontSize: 13, color: "#94a3b8", display: "block", marginBottom: 6 }}>ì°¸ì—¬ì ì´ë¦„ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
            <input type="text" value={form.members} onChange={e => setForm({...form, members: e.target.value})} placeholder="ë¯¼ìˆ˜, ì˜í¬, ì² ìˆ˜" style={inputStyle} />
            <div style={{ fontSize: 12, color: "#64748b", marginTop: 6 }}>ë³¸ì¸ ì´ë¦„ì€ ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤</div>
          </div>

          {/* í•µì‹¬ êµ¬ê°„ */}
          <div style={{ marginBottom: 24 }}>
            <label style={{ fontSize: 13, color: "#94a3b8", display: "block", marginBottom: 6 }}>í•µì‹¬ êµ¬ê°„</label>
            {form.focusStart && form.focusEnd ? (
              <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 8 }}>
                <div style={{ flex: 1, padding: "10px 14px", borderRadius: 10, background: "rgba(56,189,248,0.1)", border: "1px solid rgba(56,189,248,0.3)", fontSize: 14, color: "#38bdf8", fontWeight: 600 }}>
                  {focusLabel()}
                </div>
                <button onClick={() => { setForm({...form, focusStart: "", focusEnd: ""}); setSelectingFocus(false); setFocusStep(0); }} style={{ background: "none", border: "none", color: "#64748b", fontSize: 18, cursor: "pointer" }}>âœ•</button>
              </div>
            ) : null}
            {!selectingFocus ? (
              <button onClick={() => { setSelectingFocus(true); setFocusStep(0); }} style={{
                width: "100%", padding: "12px 14px", borderRadius: 10, border: "1px dashed #475569",
                background: "transparent", color: "#94a3b8", fontSize: 14, cursor: "pointer", fontFamily: "inherit",
              }}>
                {form.focusStart && form.focusEnd ? "êµ¬ê°„ ë‹¤ì‹œ ì„ íƒ" : "ğŸ“… ìº˜ë¦°ë”ì—ì„œ êµ¬ê°„ ì„ íƒí•˜ê¸°"}
              </button>
            ) : (
              <div>
                <div style={{ fontSize: 13, color: "#38bdf8", marginBottom: 8, fontWeight: 600 }}>
                  {focusStep === 0 ? "â–¸ ì‹œì‘ì¼ì„ ì„ íƒí•˜ì„¸ìš”" : "â–¸ ì¢…ë£Œì¼ì„ ì„ íƒí•˜ì„¸ìš”"}
                </div>
                {months.map(({year, month}) => (
                  <MiniMonthCalendar key={`${year}-${month}`} year={year} month={month}
                    today={today} maxDate={maxDate}
                    focusStart={form.focusStart} focusEnd={form.focusEnd} focusStep={focusStep}
                    onDateClick={handleFocusDateClick} />
                ))}
                <button onClick={() => { setSelectingFocus(false); setFocusStep(0); }} style={{
                  width: "100%", padding: "10px", borderRadius: 10, border: "1px solid #475569",
                  background: "transparent", color: "#94a3b8", fontSize: 13, cursor: "pointer", fontFamily: "inherit", marginTop: 8,
                }}>ì·¨ì†Œ</button>
              </div>
            )}
            <div style={{ fontSize: 12, color: "#64748b", marginTop: 6 }}>
              "2ì›” 3~4ì§¸ì£¼ì— ë³´ì" ê°™ì€ ëŒ€ëµì ì¸ ê¸°ê°„ì„ ì„¤ì •í•˜ì„¸ìš”
            </div>
          </div>

          <Button onClick={onSubmit} disabled={loading || !form.creator.trim() || !form.members.trim() || !form.focusStart || !form.focusEnd}>
            {loading ? "ìƒì„± ì¤‘..." : "ì•½ì† ë§Œë“¤ê¸°"}
          </Button>
        </Card>
      );
    }

    // â”€â”€ ë¯¸ë‹ˆ ìº˜ë¦°ë” (êµ¬ê°„ ì„ íƒìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function MiniMonthCalendar({ year, month, today, maxDate, focusStart, focusEnd, focusStep, onDateClick }) {
      const WEEKDAYS = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      const daysInMonth = getDaysInMonth(year, month);
      const firstDay = getFirstDayOfMonth(year, month);
      const monthNames = ["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"];

      const cells = [];
      for (let i = 0; i < firstDay; i++) cells.push(<div key={`e-${i}`} />);
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = fmtDate(date);
        const isInRange = date >= today && date <= maxDate;
        const weekend = isWeekend(year, month, day);
        const holiday = getHolidayName(dateStr);
        const off = weekend || !!holiday;
        const isInFocus = focusStart && focusEnd && dateStr >= focusStart && dateStr <= focusEnd;
        const isStart = dateStr === focusStart;
        const isEnd = dateStr === focusEnd;

        cells.push(
          <div key={day} onClick={() => isInRange && !off && onDateClick(dateStr)} style={{
            aspectRatio: "1", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center",
            borderRadius: 8, cursor: isInRange && !off ? "pointer" : "default",
            opacity: isInRange ? (off ? 0.35 : 1) : 0.2,
            background: isStart || isEnd ? "#38bdf8" : (isInFocus && !off) ? "rgba(56,189,248,0.2)" : "transparent",
            fontSize: 13, fontWeight: isStart || isEnd ? 700 : 400,
            color: isStart || isEnd ? "#0f172a" : (holiday || date.getDay()===0) ? "#f87171" : date.getDay()===6 ? "#60a5fa" : "#cbd5e1",
          }}>
            {day}
            {holiday && !(isStart || isEnd) && <span style={{ fontSize: 6, color: "#f87171", lineHeight: 1, marginTop: 1 }}>{holiday.length > 2 ? holiday.slice(0,2) : holiday}</span>}
          </div>
        );
      }

      return (
        <div style={{ marginBottom: 12, background: "rgba(15,23,42,0.4)", borderRadius: 12, padding: 12 }}>
          <div style={{ fontSize: 14, fontWeight: 600, marginBottom: 8, color: "#94a3b8" }}>{year}ë…„ {monthNames[month]}</div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(7,1fr)", gap: 2, marginBottom: 4 }}>
            {WEEKDAYS.map((d,i) => <div key={d} style={{ textAlign: "center", fontSize: 11, color: i===0?"#f87171":i===6?"#60a5fa":"#475569", padding: "2px 0" }}>{d}</div>)}
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(7,1fr)", gap: 2 }}>{cells}</div>
        </div>
      );
    }

    // â”€â”€ ìƒì„± ì™„ë£Œ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function CreatedScreen({ link }) {
      const [copied, setCopied] = useState(false);
      const handleCopy = () => { navigator.clipboard.writeText(link).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }); };
      return (
        <Card>
          <div style={{ textAlign: "center" }}>
            <div style={{ fontSize: 48, marginBottom: 12 }}>ğŸ‰</div>
            <div style={{ fontSize: 18, fontWeight: 700, marginBottom: 8 }}>ì•½ì†ì´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤!</div>
            <div style={{ fontSize: 14, color: "#94a3b8", marginBottom: 20 }}>ì•„ë˜ ë§í¬ë¥¼ ì°¸ì—¬ìë“¤ì—ê²Œ ê³µìœ í•˜ì„¸ìš”</div>
          </div>
          <div style={{ background: "#0f172a", borderRadius: 10, padding: "12px 14px", fontSize: 13, color: "#38bdf8", wordBreak: "break-all", marginBottom: 16, border: "1px solid #1e3a5f" }}>{link}</div>
          <Button onClick={handleCopy}>{copied ? "âœ“ ë³µì‚¬ë¨!" : "ë§í¬ ë³µì‚¬í•˜ê¸°"}</Button>
          <div style={{ marginTop: 12 }}><Button variant="secondary" onClick={() => window.location.href = link}>íˆ¬í‘œí•˜ëŸ¬ ê°€ê¸° â†’</Button></div>
        </Card>
      );
    }

    // â”€â”€ ì´ë¦„ ì„ íƒ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function SelectNameScreen({ group, onSelect }) {
      return (
        <Card>
          <div style={{ textAlign: "center", marginBottom: 24 }}>
            <div style={{ fontSize: 18, fontWeight: 700, marginBottom: 6 }}>ëˆ„êµ¬ì„¸ìš”?</div>
            <div style={{ fontSize: 14, color: "#94a3b8" }}>ë³¸ì¸ì˜ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
          </div>
          <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
            {group.members.map(name => (
              <button key={name} onClick={() => onSelect(name)} style={{
                padding: "16px 20px", borderRadius: 12, border: "1px solid #334155",
                background: "rgba(15,23,42,0.6)", color: "#e2e8f0", fontSize: 16,
                fontWeight: 600, cursor: "pointer", transition: "all 0.2s",
                textAlign: "left", fontFamily: "inherit", display: "flex", alignItems: "center", gap: 12,
              }}
              onMouseOver={e => { e.currentTarget.style.borderColor="#38bdf8"; e.currentTarget.style.background="rgba(56,189,248,0.08)"; }}
              onMouseOut={e => { e.currentTarget.style.borderColor="#334155"; e.currentTarget.style.background="rgba(15,23,42,0.6)"; }}>
                <div style={{ width: 36, height: 36, borderRadius: "50%", background: "linear-gradient(135deg,#0ea5e9,#6366f1)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, fontWeight: 700, color: "#fff", flexShrink: 0 }}>{name[0]}</div>
                {name}
              </button>
            ))}
          </div>
        </Card>
      );
    }

    // â”€â”€ ì›”ë³„ ìº˜ë¦°ë” (íˆ¬í‘œìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function MonthCalendar({ year, month, startDate, endDate, focusStart, focusEnd, votes, onDayClick }) {
      const WEEKDAYS = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      const daysInMonth = getDaysInMonth(year, month);
      const firstDay = getFirstDayOfMonth(year, month);
      const monthNames = ["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"];
      const today = new Date(); today.setHours(0,0,0,0);

      const cells = [];
      for (let i = 0; i < firstDay; i++) cells.push(<div key={`e-${i}`} />);
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = fmtDate(date);
        const isInRange = date >= startDate && date <= endDate && date >= today;
        const weekend = isWeekend(year, month, day);
        const holiday = getHolidayName(dateStr);
        const off = weekend || !!holiday;
        const vote = votes[dateStr];
        const vc = vote ? VOTE_COLORS[vote] : null;
        const isToday = fmtDate(date) === fmtDate(today);
        const isFocus = focusStart && focusEnd && dateStr >= focusStart && dateStr <= focusEnd;

        cells.push(
          <div key={day} onClick={() => isInRange && !off && onDayClick(dateStr)} style={{
            aspectRatio: "1", display: "flex", flexDirection: "column",
            alignItems: "center", justifyContent: "center", borderRadius: 10,
            cursor: isInRange && !off ? "pointer" : "default",
            opacity: isInRange ? (off ? 0.45 : 1) : 0.2,
            background: vc ? vc.bg
              : off && isFocus ? "repeating-linear-gradient(135deg, rgba(56,189,248,0.08), rgba(56,189,248,0.08) 3px, rgba(30,41,59,0.4) 3px, rgba(30,41,59,0.4) 6px)"
              : isFocus ? "rgba(56,189,248,0.1)"
              : "transparent",
            border: isToday ? "2px solid #38bdf8" : isFocus && !vc ? "1px solid rgba(56,189,248,0.25)" : "1px solid transparent",
            transition: "all 0.15s", userSelect: "none",
            position: "relative",
          }}>
            <span style={{
              fontSize: 14, fontWeight: isToday ? 800 : 500,
              color: vc ? vc.text : (holiday || date.getDay()===0) ? "#f87171" : date.getDay()===6 ? "#60a5fa" : "#cbd5e1",
            }}>{day}</span>
            {vc && <span style={{ fontSize: 9, color: vc.text, marginTop: 1, opacity: 0.9 }}>{vc.emoji}</span>}
            {holiday && !vc && <span style={{ fontSize: 7, color: "#f87171", marginTop: 1, lineHeight: 1, textAlign: "center" }}>{holiday.length > 3 ? holiday.slice(0,3) : holiday}</span>}
          </div>
        );
      }

      return (
        <Card>
          <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 14, color: "#f1f5f9" }}>
            {year}ë…„ {monthNames[month]}
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(7,1fr)", gap: 4, marginBottom: 6 }}>
            {WEEKDAYS.map((d,i) => <div key={d} style={{ textAlign: "center", fontSize: 12, fontWeight: 600, color: i===0?"#f87171":i===6?"#60a5fa":"#64748b", padding: "4px 0" }}>{d}</div>)}
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(7,1fr)", gap: 4 }}>{cells}</div>
        </Card>
      );
    }

    // â”€â”€ ìº˜ë¦°ë” íˆ¬í‘œ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function CalendarScreen({ group, userName, votes, setVotes, onSave, saving, loading, onManage, isCreator, onBack }) {
      const [linkCopied, setLinkCopied] = useState(false);
      const [saveMsg, setSaveMsg] = useState("");
      const startDate = parseDate(group.dateStart);
      const endDate = parseDate(group.dateEnd);
      const months = [];
      const cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
      while (cur <= endDate) { months.push({ year: cur.getFullYear(), month: cur.getMonth() }); cur.setMonth(cur.getMonth() + 1); }

      const focusStart = group.focusStart ? (typeof group.focusStart === "string" && group.focusStart.match(/^\d{4}-\d{2}-\d{2}$/) ? group.focusStart : fmtDate(parseDate(group.focusStart))) : "";
      const focusEnd = group.focusEnd ? (typeof group.focusEnd === "string" && group.focusEnd.match(/^\d{4}-\d{2}-\d{2}$/) ? group.focusEnd : fmtDate(parseDate(group.focusEnd))) : "";

      const handleDayClick = (dateStr) => {
        const cur = votes[dateStr] || null;
        const idx = VOTE_CYCLE.indexOf(cur);
        const next = VOTE_CYCLE[(idx+1) % VOTE_CYCLE.length];
        if (next === null) { const nv = {...votes}; delete nv[dateStr]; setVotes(nv); }
        else { setVotes({...votes, [dateStr]: next}); }
      };

      const handleCopyLink = () => { navigator.clipboard.writeText(window.location.href).then(() => { setLinkCopied(true); setTimeout(() => setLinkCopied(false), 2000); }); };

      const handleSave = async () => {
        await onSave();
        setSaveMsg("ì €ì¥ ì™„ë£Œ âœ“");
        setTimeout(() => setSaveMsg(""), 2000);
      };

      const counts = Object.values(votes).reduce((a,v) => { a[v]=(a[v]||0)+1; return a; }, {});

      return (
        <div>
          <Card style={{ padding: 16 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <button onClick={onBack} style={{ background: "none", border: "none", color: "#94a3b8", fontSize: 14, cursor: "pointer", fontFamily: "inherit" }}>â† ë’¤ë¡œ</button>
              <div style={{ fontSize: 15, fontWeight: 700 }}><span style={{ color: "#38bdf8" }}>{userName}</span>ë‹˜ì˜ íˆ¬í‘œ</div>
              <button onClick={handleCopyLink} style={{ background: "none", border: "none", color: linkCopied ? "#22c55e" : "#64748b", fontSize: 13, cursor: "pointer", fontFamily: "inherit", whiteSpace: "nowrap" }}>
                {linkCopied ? "âœ“ ë³µì‚¬ë¨" : "ğŸ”— ë§í¬"}
              </button>
            </div>
          </Card>

          {/* í•µì‹¬êµ¬ê°„ ì•ˆë‚´ */}
          {focusStart && focusEnd && (
            <Card style={{ padding: 14, background: "rgba(56,189,248,0.06)", border: "1px solid rgba(56,189,248,0.2)" }}>
              <div style={{ textAlign: "center", fontSize: 13, color: "#38bdf8", fontWeight: 600 }}>
                í•µì‹¬ êµ¬ê°„: {fmtDisplay(parseDate(focusStart))} ~ {fmtDisplay(parseDate(focusEnd))}
              </div>
              <div style={{ textAlign: "center", fontSize: 12, color: "#64748b", marginTop: 4 }}>
                í•˜ëŠ˜ìƒ‰ ì˜ì—­ ìœ„ì£¼ë¡œ íˆ¬í‘œí•´ì£¼ì„¸ìš” Â· ì˜ì—­ ë°–ë„ íˆ¬í‘œ ê°€ëŠ¥
              </div>
            </Card>
          )}

          {/* ë²”ë¡€ */}
          <Card style={{ padding: 14 }}>
            <div style={{ display: "flex", justifyContent: "center", gap: 20, fontSize: 13 }}>
              {Object.entries(VOTE_COLORS).map(([k,v]) => (
                <div key={k} style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <div style={{ width: 14, height: 14, borderRadius: 4, background: v.bg }} />
                  <span style={{ color: "#94a3b8" }}>{v.label}</span>
                  <span style={{ color: "#64748b" }}>({counts[k]||0})</span>
                </div>
              ))}
            </div>
            <div style={{ textAlign: "center", fontSize: 12, color: "#475569", marginTop: 8 }}>
              ë¹ˆ ë‚ ì§œ = ë¹„ì„ í˜¸ Â· ì£¼ë§ì€ íˆ¬í‘œ ëŒ€ìƒ ì•„ë‹˜
            </div>
          </Card>

          {months.map(({year,month}) => (
            <MonthCalendar key={`${year}-${month}`} year={year} month={month}
              startDate={startDate} endDate={endDate}
              focusStart={focusStart} focusEnd={focusEnd}
              votes={votes} onDayClick={handleDayClick} />
          ))}

          <div style={{ position: "sticky", bottom: 0, padding: "16px 0 24px", background: "linear-gradient(transparent, #0f172a 20%)" }}>
            <Button onClick={handleSave} disabled={saving}>
              {saving ? "ì €ì¥ ì¤‘..." : saveMsg || "íˆ¬í‘œ ì €ì¥í•˜ê¸°"}
            </Button>
            {isCreator && <div style={{ marginTop: 10 }}><Button variant="secondary" onClick={onManage}>íˆ¬í‘œ ê´€ë¦¬ (ë§ˆê°)</Button></div>}
          </div>
        </div>
      );
    }

    // â”€â”€ ê´€ë¦¬ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function ManageScreen({ group, voteStatus, onClose, onBack, loading, onRefresh }) {
      const [confirmClose, setConfirmClose] = useState(false);
      if (!voteStatus) return <LoadingSpinner />;
      const notVoted = voteStatus.members.filter(m => !m.voted);
      const allVoted = notVoted.length === 0;

      return (
        <div>
          <Card style={{ padding: 16 }}>
            <button onClick={onBack} style={{ background: "none", border: "none", color: "#94a3b8", fontSize: 14, cursor: "pointer", fontFamily: "inherit" }}>â† ìº˜ë¦°ë”ë¡œ ëŒì•„ê°€ê¸°</button>
          </Card>
          <Card>
            <div style={{ fontSize: 18, fontWeight: 700, marginBottom: 20 }}>íˆ¬í‘œ í˜„í™©</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 10, marginBottom: 20 }}>
              {voteStatus.members.map(m => (
                <div key={m.name} style={{
                  display: "flex", justifyContent: "space-between", alignItems: "center",
                  padding: "12px 16px", borderRadius: 10,
                  background: m.voted ? "rgba(34,197,94,0.1)" : "rgba(239,68,68,0.1)",
                  border: `1px solid ${m.voted ? "rgba(34,197,94,0.2)" : "rgba(239,68,68,0.2)"}`,
                }}>
                  <span style={{ fontWeight: 600 }}>{m.name}</span>
                  <span style={{ fontSize: 13, color: m.voted ? "#22c55e" : "#ef4444", fontWeight: 600 }}>{m.voted ? "íˆ¬í‘œ ì™„ë£Œ âœ“" : "ë¯¸íˆ¬í‘œ"}</span>
                </div>
              ))}
            </div>
            <div style={{ fontSize: 13, color: "#64748b", textAlign: "center", marginBottom: 16 }}>{voteStatus.votedCount}/{voteStatus.totalMembers}ëª… íˆ¬í‘œ ì™„ë£Œ</div>
            <Button variant="secondary" onClick={onRefresh} style={{ marginBottom: 12 }}>ìƒˆë¡œê³ ì¹¨</Button>
            {!confirmClose ? (
              <Button variant={allVoted ? "primary" : "danger"} onClick={() => setConfirmClose(true)}>
                {allVoted ? "íˆ¬í‘œ ë§ˆê°í•˜ê¸°" : "íˆ¬í‘œ ë§ˆê°í•˜ê¸° (ë¯¸íˆ¬í‘œì ìˆìŒ)"}
              </Button>
            ) : (
              <Card style={{ background: "rgba(239,68,68,0.08)", border: "1px solid rgba(239,68,68,0.3)" }}>
                {notVoted.length > 0 ? (
                  <div style={{ marginBottom: 16 }}>
                    <div style={{ fontSize: 15, fontWeight: 700, color: "#f87171", marginBottom: 8 }}>ë¯¸íˆ¬í‘œìë¥¼ ì œì™¸í•˜ê³  ë§ˆê°í• ê¹Œìš”?</div>
                    <div style={{ fontSize: 14, color: "#94a3b8" }}>ì œì™¸ ëŒ€ìƒ: {notVoted.map(m => m.name).join(", ")}</div>
                  </div>
                ) : (
                  <div style={{ marginBottom: 16 }}>
                    <div style={{ fontSize: 15, fontWeight: 700, marginBottom: 8 }}>íˆ¬í‘œë¥¼ ë§ˆê°í• ê¹Œìš”?</div>
                    <div style={{ fontSize: 14, color: "#94a3b8" }}>ë§ˆê° í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                  </div>
                )}
                <div style={{ display: "flex", gap: 10 }}>
                  <Button variant="secondary" onClick={() => setConfirmClose(false)} style={{ flex: 1 }}>ì·¨ì†Œ</Button>
                  <Button variant="danger" onClick={() => onClose(notVoted.map(m => m.name))} disabled={loading} style={{ flex: 1 }}>{loading ? "ì²˜ë¦¬ ì¤‘..." : "ë§ˆê° í™•ì¸"}</Button>
                </div>
              </Card>
            )}
          </Card>
        </div>
      );
    }

    // â”€â”€ ê²°ê³¼ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function ResultScreen({ result, group }) {
      if (!result || !result.success) return <Card><div style={{ textAlign: "center", padding: 24, color: "#94a3b8" }}>ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div></Card>;

      const cfg = {
        1: { icon: "ğŸ‰", color: "#22c55e", bg: "rgba(34,197,94,0.08)", border: "rgba(34,197,94,0.3)" },
        2: { icon: "ğŸ“…", color: "#f59e0b", bg: "rgba(245,158,11,0.08)", border: "rgba(245,158,11,0.3)" },
        3: { icon: "âš ï¸", color: "#ef4444", bg: "rgba(239,68,68,0.08)", border: "rgba(239,68,68,0.3)" },
      }[result.tier] || { icon: "ğŸ“…", color: "#94a3b8", bg: "rgba(148,163,184,0.08)", border: "rgba(148,163,184,0.3)" };

      return (
        <div>
          <Card style={{ background: cfg.bg, border: `1px solid ${cfg.border}`, textAlign: "center" }}>
            <div style={{ fontSize: 48, marginBottom: 12 }}>{cfg.icon}</div>
            <div style={{ fontSize: 20, fontWeight: 800, marginBottom: 6, color: cfg.color }}>{result.message}</div>
            <div style={{ fontSize: 13, color: "#64748b" }}>
              ì°¸ì—¬ ì¸ì›: {result.totalMembers}ëª…
              {group && group.excluded && group.excluded.length > 0 && <span> (ì œì™¸: {group.excluded.join(", ")})</span>}
            </div>
            {result.fromFocus === false && <div style={{ fontSize: 12, color: "#f59e0b", marginTop: 6 }}>í•µì‹¬ êµ¬ê°„ì—ì„œ ê²°ê³¼ë¥¼ ì°¾ì§€ ëª»í•´ ì „ì²´ ë²”ìœ„ì—ì„œ ì‚°ì¶œí–ˆìŠµë‹ˆë‹¤</div>}
          </Card>
          <Card>
            <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
              {result.dates.map((d, i) => {
                const date = parseDate(d.date);
                return (
                  <div key={i} style={{ padding: "16px 20px", borderRadius: 12, background: "rgba(15,23,42,0.6)", border: `1px solid ${cfg.border}` }}>
                    <div style={{ fontSize: 18, fontWeight: 800, color: cfg.color, marginBottom: result.tier > 1 ? 8 : 0 }}>
                      {date ? fmtDisplay(date) : d.date}
                    </div>
                    {result.tier === 2 && (
                      <div style={{ fontSize: 13, color: "#94a3b8" }}>
                        ì„ í˜¸ {d.preferred}ëª…
                        {d.neutralUsers && d.neutralUsers.length > 0 && <span style={{ color: "#f59e0b" }}> Â· ë¹„ì„ í˜¸: {d.neutralUsers.join(", ")}</span>}
                      </div>
                    )}
                    {result.tier === 3 && (
                      <div style={{ fontSize: 13 }}>
                        <div style={{ color: "#f87171", marginBottom: 2 }}>ì ˆëŒ€ë¶ˆê°€ {d.unavailable}ëª… ({d.unavailableUsers.join(", ")})</div>
                        <div style={{ color: "#94a3b8" }}>
                          ì„ í˜¸ {d.preferred}ëª…
                          {d.neutralUsers && d.neutralUsers.length > 0 && <span style={{ color: "#f59e0b" }}> Â· ë¹„ì„ í˜¸: {d.neutralUsers.join(", ")}</span>}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </Card>
        </div>
      );
    }

    // â”€â”€ ë©”ì¸ ì•± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function App() {
      const [screen, setScreen] = useState("loading");
      const [groupId, setGroupId] = useState(null);
      const [group, setGroup] = useState(null);
      const [userName, setUserName] = useState(null);
      const [votes, setVotes] = useState({});
      const [saving, setSaving] = useState(false);
      const [loading, setLoading] = useState(false);
      const [result, setResult] = useState(null);
      const [voteStatus, setVoteStatus] = useState(null);
      const [createForm, setCreateForm] = useState({ creator: "", members: "", focusStart: "", focusEnd: "" });
      const [createdLink, setCreatedLink] = useState(null);
      const [error, setError] = useState(null);

      useEffect(() => {
        const p = new URLSearchParams(window.location.search);
        const gId = p.get("g");
        if (gId) { setGroupId(gId); setScreen("loadingGroup"); }
        else { setScreen("create"); }
      }, []);

      useEffect(() => {
        if (screen !== "loadingGroup" || !groupId) return;
        setLoading(true);
        apiCall({ action: "getGroup", groupId })
          .then(data => {
            if (data.error) { setError("ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"); setScreen("error"); }
            else { setGroup(data.group); setScreen(data.group.status === "closed" ? "resultLoading" : "selectName"); }
          })
          .catch(() => { setError("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"); setScreen("error"); })
          .finally(() => setLoading(false));
      }, [screen, groupId]);

      useEffect(() => {
        if (screen !== "resultLoading" || !groupId) return;
        apiCall({ action: "getResult", groupId })
          .then(data => { setResult(data); setScreen("result"); })
          .catch(() => { setError("ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"); setScreen("error"); });
      }, [screen, groupId]);

      const loadMyVotes = useCallback(name => {
        setLoading(true);
        apiCall({ action: "getMyVotes", groupId, userName: name })
          .then(data => {
            const vm = {};
            if (data.votes) data.votes.forEach(v => { const d = parseDate(v.date); if (d) vm[fmtDate(d)] = v.voteType; });
            setVotes(vm);
          }).finally(() => setLoading(false));
      }, [groupId]);

      const handleCreate = async () => {
        if (!createForm.creator.trim() || !createForm.members.trim()) return;
        setLoading(true);
        try {
          const all = createForm.members.split(",").map(s=>s.trim()).filter(Boolean);
          if (!all.includes(createForm.creator.trim())) all.unshift(createForm.creator.trim());
          const data = await apiCall({
            action: "createGroup",
            creator: createForm.creator.trim(),
            members: all.join(","),
            focusStart: createForm.focusStart,
            focusEnd: createForm.focusEnd,
          });
          if (data.success) {
            const link = `${window.location.origin}${window.location.pathname}?g=${data.groupId}`;
            setCreatedLink(link); setScreen("created");
          }
        } catch { setError("ê·¸ë£¹ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"); setScreen("error"); }
        finally { setLoading(false); }
      };

      const handleSave = async () => {
        setSaving(true);
        try {
          const arr = Object.entries(votes).map(([date,voteType]) => ({date,voteType}));
          await apiCall({ action: "saveVotes", groupId, userName, votes: JSON.stringify(arr) });
        } finally { setSaving(false); }
      };

      const loadVoteStatus = async () => { const data = await apiCall({ action: "getVoteStatus", groupId }); setVoteStatus(data); };

      const handleClose = async (excluded) => {
        setLoading(true);
        try { await apiCall({ action: "closeGroup", groupId, excluded: excluded.join(",") }); setScreen("resultLoading"); }
        finally { setLoading(false); }
      };

      return (
        <div style={{ maxWidth: 480, margin: "0 auto", padding: "0 16px" }}>
          <div style={{ textAlign: "center", padding: "32px 0 16px" }}>
            <div style={{ fontSize: 28, fontWeight: 800, letterSpacing: "-0.5px" }}>
              <span style={{ color: "#38bdf8" }}>ë‚ ì§œ</span><span style={{ color: "#e2e8f0" }}>ì¡ì</span>
            </div>
            <div style={{ fontSize: 13, color: "#64748b", marginTop: 4 }}>ì‰½ê³  ë¹ ë¥¸ ì•½ì† ë‚ ì§œ ì¡°ìœ¨</div>
          </div>
          {(screen === "loading" || screen === "loadingGroup" || screen === "resultLoading") && <LoadingSpinner />}
          {screen === "error" && <ErrorScreen message={error} />}
          {screen === "create" && <CreateScreen form={createForm} setForm={setCreateForm} onSubmit={handleCreate} loading={loading} />}
          {screen === "created" && <CreatedScreen link={createdLink} />}
          {screen === "selectName" && group && <SelectNameScreen group={group} onSelect={name => { setUserName(name); loadMyVotes(name); setScreen("calendar"); }} />}
          {screen === "calendar" && group && <CalendarScreen group={group} userName={userName} votes={votes} setVotes={setVotes} onSave={handleSave} saving={saving} loading={loading} onManage={() => { loadVoteStatus(); setScreen("manage"); }} isCreator={userName === group.creator} onBack={() => setScreen("selectName")} />}
          {screen === "manage" && group && <ManageScreen group={group} voteStatus={voteStatus} onClose={handleClose} onBack={() => setScreen("calendar")} loading={loading} onRefresh={loadVoteStatus} />}
          {screen === "result" && result && <ResultScreen result={result} group={group} />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
